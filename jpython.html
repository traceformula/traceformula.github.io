<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Python Runner with Code Sharing</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.26.1/min/vs/editor/editor.main.min.css">

<style>
body { font-family: Arial; background: #f5f5f5; margin: 20px; }
h1 { color: #333; }
#editor { width: 100%; height: 250px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; }
button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 6px; background-color: #007bff; color: white; cursor: pointer; margin-bottom: 10px; }
button:hover { background-color: #0056b3; }
#plot { margin-top: 20px; }
#controls { margin-top: 10px; display: flex; gap: 20px; flex-wrap: wrap; }
.control { display: flex; flex-direction: column; }
label { margin-bottom: 4px; font-weight: bold; }
input[type=range] { width: 200px; }
p, #status { color: #555; }
</style>
</head>
<body>

<h1>Interactive Python Runner with Code Sharing</h1>
<div id="status">Loading...</div>
<div id="editor"></div>
<div id="controls">
  <div class="control">
    <label for="frequency">Frequency</label>
    <input type="range" id="frequency" min="1" max="10" value="1" step="0.1">
  </div>
  <div class="control">
    <label for="amplitude">Amplitude</label>
    <input type="range" id="amplitude" min="1" max="5" value="1" step="0.1">
  </div>
</div>
<button onclick="runPython()">Run Python</button>
<button onclick="shareCode()">Share Code</button>
<p>üëâ Open DevTools console for <code>print()</code>. Plots show below:</p>
<div id="plot"></div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.26.1/min/vs/loader.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.0/full/pyodide.js"></script>

<script>
let editor, pyodideReadyPromise;
const statusEl = document.getElementById("status");

// --- Utility: load code from URL if exists ---
function loadCodeFromURL() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  return code ? decodeURIComponent(atob(code)) : null;
}

// --- Initialize Monaco Editor ---
require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.26.1/min/vs' }});
require(['vs/editor/editor.main'], function() {
  const defaultCode = loadCodeFromURL() || `import matplotlib.pyplot as plt
import numpy as np
import time

class Test:
  def run(self):  
    print("hello", Test)

Test().run()

# Slider variables
freq = SINE_WAVE_FREQUENCY
amp = SINE_WAVE_AMP

x = np.linspace(0, 10, 100)
y = amp * np.sin(freq*x)

plt.plot(x, y)
plt.title("Interactive Sine Wave")
plt.xlabel("x")
plt.ylabel("y")
plt.show()

# time.sleep(1)
print("Done ronnnnnning!")`;
  
  editor = monaco.editor.create(document.getElementById('editor'), {
    value: defaultCode,
    language: 'python',
    theme: 'vs-dark',
    automaticLayout: true
  });
});

// --- Load Pyodide ---
async function loadPyodideLazy() {
  statusEl.textContent = "‚è≥ Loading Pyodide...";
  pyodideReadyPromise = loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.0/full/" });
  await pyodideReadyPromise;
  statusEl.textContent = "‚úÖ Pyodide ready!";
}
loadPyodideLazy();

// --- Run Python ---
async function runPython() {
  if (!editor || !pyodideReadyPromise) return;
  const pyodide = await pyodideReadyPromise;
  const code = editor.getValue();
  const freq = parseFloat(document.getElementById("frequency").value);
  const amp = parseFloat(document.getElementById("amplitude").value);
  
  document.getElementById("plot").innerHTML = "";

  try {
    await pyodide.loadPackage(["numpy", "matplotlib"]);

    pyodide.runPython(`
import sys
from js import console
import matplotlib
# matplotlib.use("AGG")
import matplotlib.pyplot as plt
plt.close("all")
# plt.show = lambda *args, **kwargs: None  # override show
class ConsoleWriter:
    def write(self,s): 
        if s.strip(): console.log(s)
    def flush(self): pass
sys.stdout = ConsoleWriter()
sys.stderr = ConsoleWriter()
`);

    pyodide.globals.set("SINE_WAVE_FREQUENCY", freq);
    pyodide.globals.set("SINE_WAVE_AMP", amp);
    await pyodide.runPythonAsync(code);

    const imgTag = await pyodide.runPythonAsync(`
import io, base64
if plt.get_fignums():
    fig = plt.gcf()
    buf = io.BytesIO()
    fig.savefig(buf, format="png")
    buf.seek(0)
    img_bytes = base64.b64encode(buf.read()).decode("ascii")
    plt.close("all")
    f"<img src='data:image/png;base64,{img_bytes}'/>"
else:
    ""
`);
    if (imgTag) document.getElementById("plot").innerHTML = imgTag;

  } catch (err) {
    console.error("Python error:", err);
    statusEl.textContent = "‚ùå Python error. Check console.";
  }
}

// --- Share code ---
function shareCode() {
  const code = editor.getValue();
  const encoded = btoa(encodeURIComponent(code));
  const url = `${window.location.origin}${window.location.pathname}?code=${encoded}`;
  navigator.clipboard.writeText(url).then(() => alert("Shareable link copied to clipboard!"));
}

// --- Live sliders ---
document.getElementById("frequency").addEventListener("input", runPython);
document.getElementById("amplitude").addEventListener("input", runPython);

</script>
</body>
</html>
