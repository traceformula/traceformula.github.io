<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Mai Hoa D·ªãch S·ªë ‚Äì Qu·∫ª & Can Chi (DST-safe)</title>

<!-- √Çm l·ªãch (offline, ƒë·∫ßy ƒë·ªß) -->
<script>
var AmLich={INT:Math.floor,jdFromDate:function(d,m,y){var a=this.INT((14-m)/12);var yy=y+4800-a;var mm=m+12*a-3;var jd=d+this.INT((153*mm+2)/5)+365*yy+this.INT(yy/4)-this.INT(yy/100)+this.INT(yy/400)-32045;if(jd<2299161)jd=d+this.INT((153*mm+2)/5)+365*yy+this.INT(yy/4)-32083;return jd},NewMoon:function(k){var T=k/1236.85,T2=T*T,T3=T2*T,dr=Math.PI/180;var Jd1=2415020.75933+29.53058868*k+0.0001178*T2-0.000000155*T3;Jd1+=0.00033*Math.sin((166.56+132.87*T-0.009173*T2)*dr);var M=359.2242+29.10535608*k-0.0000333*T2-0.00000347*T3;var Mpr=306.0253+385.81691806*k+0.0107306*T2+0.00001236*T3;var F=21.2964+390.67050646*k-0.0016528*T2-0.00000239*T3;var C1=(0.1734-0.000393*T)*Math.sin(M*dr)+0.0021*Math.sin(2*M*dr)-0.4068*Math.sin(Mpr*dr)+0.0161*Math.sin(2*Mpr*dr)+0.0104*Math.sin(2*F*dr)-0.0051*Math.sin((M+Mpr)*dr);var deltat=T<-11?0.001+0.000839*T+0.0002261*T2-0.00000845*T3-0.000000081*T*T3:-0.000278+0.000265*T+0.000262*T2;return Jd1+C1-deltat},SunLongitude:function(jdn){var T=(jdn-2451545.0)/36525;var dr=Math.PI/180;var M=357.52910+35999.05030*T-0.0001559*T*T-0.00000048*T*T*T;var L0=280.46645+36000.76983*T+0.0003032*T*T;var DL=(1.914600-0.004817*T-0.000014*T*T)*Math.sin(dr*M)+(0.019993-0.000101*T)*Math.sin(2*dr*M)+0.000290*Math.sin(3*dr*M);var L=L0+DL;L=L*dr;L=L-2*Math.PI*Math.floor(L/(2*Math.PI));return L},getSunLongitude:function(dayNumber,timeZone){return Math.floor(this.SunLongitude(dayNumber-0.5-timeZone/24)/Math.PI*6)},getNewMoonDay:function(k,tz){return Math.floor(this.NewMoon(k)+0.5+tz/24)},getLunarMonth11:function(yy,tz){var off=this.jdFromDate(31,12,yy)-2415021;var k=Math.floor(off/29.530588853);var nm=this.getNewMoonDay(k,tz);var sunLong=this.getSunLongitude(nm,tz);if(sunLong>=9)nm=this.getNewMoonDay(k-1,tz);return nm},getLeapMonthOffset:function(a11,tz){var k=Math.floor((a11-2415021.076998695)/29.530588853+0.5);var last,arc=this.getSunLongitude(this.getNewMoonDay(k+1,tz),tz);var i=1;do{last=arc;i++;arc=this.getSunLongitude(this.getNewMoonDay(k+i,tz),tz);}while(arc!=last&&i<14);return i-1},convertSolar2Lunar:function(dd,mm,yy,tz){var dayNumber=this.jdFromDate(dd,mm,yy);var k=Math.floor((dayNumber-2415021.076998695)/29.530588853);var monthStart=this.getNewMoonDay(k+1,tz);if(monthStart>dayNumber)monthStart=this.getNewMoonDay(k,tz);var a11=this.getLunarMonth11(yy,tz);var b11=a11,lunarYear;if(a11>=monthStart){a11=this.getLunarMonth11(yy-1,tz);lunarYear=yy;}else{b11=this.getLunarMonth11(yy+1,tz);lunarYear=yy+1;}var lunarDay=dayNumber-monthStart+1;var diff=Math.floor((monthStart-a11)/29);var lunarLeap=0,lunarMonth=diff+11;if(b11-a11>365){var leapMonthDiff=this.getLeapMonthOffset(a11,tz);if(diff>=leapMonthDiff){lunarMonth=diff+10;if(diff==leapMonthDiff)lunarLeap=1;}}if(lunarMonth>12)lunarMonth-=12;if(lunarMonth>=11&&diff<4)lunarYear-=1;return[lunarDay,lunarMonth,lunarYear,lunarLeap];}};
</script>
</head>
<body>
<h2>üîÆ Mai Hoa D·ªãch S·ªë ‚Äì Qu·∫ª & Can Chi</h2>

<label>Ng√†y d∆∞∆°ng: <input type="date" id="solarDate"></label><br>
<label>Gi·ªù (hh:mm): <input type="time" id="solarTime" value="01:23"></label><br>
<label>M√∫i gi·ªù (IANA):
  <select id="iana">
    <option value="Asia/Ho_Chi_Minh">Asia/Ho_Chi_Minh (VN)</option>
    <option value="America/New_York">America/New_York (NY)</option>
    <option value="America/Los_Angeles">America/Los_Angeles (CA)</option>
  </select>
</label>
<label style="margin-left:10px;"><input type="checkbox" id="vnStd"> D√πng chu·∫©n l·ªãch VN (UTC+7)</label><br>
<button onclick="calc()">L·∫≠p qu·∫ª</button>

<pre id="out" style="white-space:pre-wrap;"></pre>

<script>
// ===== B√°t qu√°i & 64 qu·∫ª =====
const TRIGRAMS={1:{vn:"C√†n",symbol:"‚ò∞",lines:[1,1,1]},2:{vn:"ƒêo√†i",symbol:"‚ò±",lines:[1,1,0]},3:{vn:"Ly",symbol:"‚ò≤",lines:[1,0,1]},4:{vn:"Ch·∫•n",symbol:"‚ò≥",lines:[1,0,0]},5:{vn:"T·ªën",symbol:"‚ò¥",lines:[0,1,1]},6:{vn:"Kh·∫£m",symbol:"‚òµ",lines:[0,1,0]},7:{vn:"C·∫•n",symbol:"‚ò∂",lines:[0,0,1]},8:{vn:"Kh√¥n",symbol:"‚ò∑",lines:[0,0,0]}};
const HEX_NAMES=[[],["C√†n","C√†n Vi Thi√™n","‰πæÁÇ∫Â§©"],["C√†n","Phong Thi√™n Ti·ªÉu S√∫c","È¢®Â§©Â∞èÁïú"],["C√†n","H·ªèa Thi√™n ƒê·∫°i H·ªØu","ÁÅ´Â§©Â§ßÊúâ"],["C√†n","Tr·∫°ch Thi√™n Qu·∫£i","Êæ§Â§©Â§¨"],["C√†n","S∆°n Thi√™n ƒê·∫°i S√∫c","Â±±Â§©Â§ßÁïú"],["C√†n","Th·ªßy Thi√™n Nhu","Ê∞¥Â§©ÈúÄ"],["C√†n","L√¥i Thi√™n ƒê·∫°i Tr√°ng","Èõ∑Â§©Â§ßÂ£Ø"],["C√†n","ƒê·ªãa Thi√™n Th√°i","Âú∞Â§©Ê≥∞"],["ƒêo√†i","Thi√™n Tr·∫°ch L√Ω","Â§©Êæ§Â±•"],["ƒêo√†i","Phong Tr·∫°ch Trung Phu","È¢®Êæ§‰∏≠Â≠ö"],["ƒêo√†i","H·ªèa Tr·∫°ch Khu√™","ÁÅ´Êæ§ÁùΩ"],["ƒêo√†i","Tr·∫°ch Vi ƒêo√†i","ÂÖåÁÇ∫Êæ§"],["ƒêo√†i","S∆°n Tr·∫°ch T·ªïn","Â±±Êæ§Êêç"],["ƒêo√†i","Th·ªßy Tr·∫°ch Ti·∫øt","Ê∞¥Êæ§ÁØÄ"],["ƒêo√†i","L√¥i Tr·∫°ch Quy Mu·ªôi","Èõ∑Êæ§Ê≠∏Â¶π"],["ƒêo√†i","ƒê·ªãa Tr·∫°ch L√¢m","Âú∞Êæ§Ëá®"],["Ly","Thi√™n H·ªèa ƒê·ªìng Nh√¢n","Â§©ÁÅ´Âêå‰∫∫"],["Ly","Phong H·ªèa Gia Nh√¢n","È¢®ÁÅ´ÂÆ∂‰∫∫"],["Ly","Ly Vi H·ªèa","Èõ¢ÁÇ∫ÁÅ´"],["Ly","Tr·∫°ch H·ªèa C√°ch","Êæ§ÁÅ´Èù©"],["Ly","S∆°n H·ªèa B√≠","Â±±ÁÅ´Ë≥Å"],["Ly","Th·ªßy H·ªèa K√Ω T·∫ø","Ê∞¥ÁÅ´Êó¢Êøü"],["Ly","L√¥i H·ªèa Phong","Èõ∑ÁÅ´Ë±ê"],["Ly","ƒê·ªãa H·ªèa Minh Di","Âú∞ÁÅ´ÊòéÂ§∑"],["Ch·∫•n","Thi√™n L√¥i V√¥ V·ªçng","Â§©Èõ∑Êó†Â¶Ñ"],["Ch·∫•n","Phong L√¥i √çch","È¢®Èõ∑Áõä"],["Ch·∫•n","H·ªèa L√¥i Ph·ªá H·∫°p","ÁÅ´Èõ∑Âô¨Âóë"],["Ch·∫•n","Tr·∫°ch L√¥i T√πy","Êæ§Èõ∑Èö®"],["Ch·∫•n","S∆°n L√¥i Di","Â±±Èõ∑È†§"],["Ch·∫•n","Th·ªßy L√¥i Tru√¢n","Ê∞¥Èõ∑Â±Ø"],["Ch·∫•n","Ch·∫•n Vi L√¥i","ÈúáÁÇ∫Èõ∑"],["Ch·∫•n","ƒê·ªãa L√¥i Ph·ª•c","Âú∞Èõ∑Âæ©"],["T·ªën","Thi√™n Phong C·∫•u","Â§©È¢®Âß§"],["T·ªën","T·ªën Vi Phong","Â∑ΩÁÇ∫È¢®"],["T·ªën","H·ªèa Phong ƒê·ªânh","ÁÅ´È¢®Èºé"],["T·ªën","Tr·∫°ch Phong ƒê·∫°i Qu√°","Êæ§È¢®Â§ßÈÅé"],["T·ªën","S∆°n Phong C·ªï","Â±±È¢®Ë†±"],["T·ªën","Th·ªßy Phong T·ªânh","Ê∞¥È¢®‰∫ï"],["T·ªën","L√¥i Phong H·∫±ng","Èõ∑È¢®ÊÅÜ"],["T·ªën","ƒê·ªãa Phong ThƒÉng","Âú∞È¢®Âçá"],["Kh·∫£m","Thi√™n Th·ªßy T·ª•ng","Â§©Ê∞¥Ë®ü"],["Kh·∫£m","Phong Th·ªßy Ho√°n","È¢®Ê∞¥Ê∏ô"],["Kh·∫£m","H·ªèa Th·ªßy V·ªã T·∫ø","ÁÅ´Ê∞¥Êú™Êøü"],["Kh·∫£m","Tr·∫°ch Th·ªßy Kh·ªën","Êæ§Ê∞¥Âõ∞"],["Kh·∫£m","S∆°n Th·ªßy M√¥ng","Â±±Ê∞¥Ëíô"],["Kh·∫£m","Kh·∫£m Vi Th·ªßy","ÂùéÁÇ∫Ê∞¥"],["Kh·∫£m","L√¥i Th·ªßy Gi·∫£i","Èõ∑Ê∞¥Ëß£"],["Kh·∫£m","ƒê·ªãa Th·ªßy S∆∞","Âú∞Ê∞¥Â∏´"],["C·∫•n","Thi√™n S∆°n ƒê·ªôn","Â§©Â±±ÈÅØ"],["C·∫•n","Phong S∆°n Ti·ªám","È¢®Â±±Êº∏"],["C·∫•n","H·ªèa S∆°n L·ªØ","ÁÅ´Â±±ÊóÖ"],["C·∫•n","Tr·∫°ch S∆°n H√†m","Êæ§Â±±Âí∏"],["C·∫•n","C·∫•n Vi S∆°n","ËâÆÁÇ∫Â±±"],["C·∫•n","Th·ªßy S∆°n Ki·ªÉn","Ê∞¥Â±±Ëπá"],["C·∫•n","L√¥i S∆°n Ti·ªÉu Qu√°","Èõ∑Â±±Â∞èÈÅé"],["C·∫•n","ƒê·ªãa S∆°n Khi√™m","Âú∞Â±±Ë¨ô"],["Kh√¥n","Thi√™n ƒê·ªãa Bƒ©","Â§©Âú∞Âê¶"],["Kh√¥n","Phong ƒê·ªãa Quan","È¢®Âú∞ËßÄ"],["Kh√¥n","H·ªèa ƒê·ªãa T·∫•n","ÁÅ´Âú∞Êôâ"],["Kh√¥n","Tr·∫°ch ƒê·ªãa T·ª•y","Êæ§Âú∞ËêÉ"],["Kh√¥n","S∆°n ƒê·ªãa B√°c","Â±±Âú∞Ââù"],["Kh√¥n","Th·ªßy ƒê·ªãa T·ª∑","Ê∞¥Âú∞ÊØî"],["Kh√¥n","L√¥i ƒê·ªãa D·ª±","Èõ∑Âú∞Ë±´"],["Kh√¥n","Kh√¥n Vi ƒê·ªãa","Âù§ÁÇ∫Âú∞"]];

const CAN=["Gi√°p","·∫§t","B√≠nh","ƒêinh","M·∫≠u","K·ª∑","Canh","T√¢n","Nh√¢m","Qu√Ω"];
const CHI=["T√Ω","S·ª≠u","D·∫ßn","M√£o","Th√¨n","T·ªµ","Ng·ªç","M√πi","Th√¢n","D·∫≠u","Tu·∫•t","H·ª£i"];

// ===== Helpers =====
const mod1=(x,m)=>{const r=x%m;return r===0?m:r;}
function chiIndexFromHour(h){if(h===23||h===0)return 1;if(h<=2)return 2;if(h<=4)return 3;if(h<=6)return 4;if(h<=8)return 5;if(h<=10)return 6;if(h<=12)return 7;if(h<=14)return 8;if(h<=16)return 9;if(h<=18)return 10;if(h<=20)return 11;return 12;}
const buildHex=(l,u)=>[...TRIGRAMS[l].lines,...TRIGRAMS[u].lines];
const mutate=(lines,m)=>{const o=[...lines];o[m-1]=o[m-1]?0:1;return o;}
const render=(lines,m)=>{const s=v=>v?"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ":"‚îÄ‚îÄ ‚îÄ‚îÄ";let t="";for(let i=6;i>=1;i--){t+=i+" | "+s(lines[i-1]);if(i===m)t+=" ‚á¢ ƒë·ªông";t+="\n";}return t;}
const getHexName=(u,l)=>HEX_NAMES[(u-1)*8+l];
function trigramIndex(bits){for(let i=1;i<=8;i++){const t=TRIGRAMS[i].lines;if(t[0]===bits[0]&&t[1]===bits[1]&&t[2]===bits[2])return i;}return 1;}
function offsetHoursAt(iana,y,m,d,hh,mm){const dtUTC=new Date(Date.UTC(y,m-1,d,hh,mm));const fmt=new Intl.DateTimeFormat("en-US",{timeZone:iana,timeZoneName:"shortOffset",hour12:false});const s=fmt.format(dtUTC);const m1=s.match(/GMT([+-]\d{2})(?::?(\d{2}))?/);if(!m1)return 0;const h=parseInt(m1[1],10);const mi=m1[2]?parseInt(m1[2],10):0;return h+(h>=0?mi/60:-mi/60);}

// ===== Can‚ÄìChi core =====
// Can Chi ng√†y: chu·∫©n theo chu k·ª≥ 60 v·ªõi m·ªëc JD
function dayCanChi(dd,mm,yy){
  const jd=AmLich.jdFromDate(dd,mm,yy);
  const canIdx=(jd+9)%10;      // 0..9  -> Gi√°p
  const chiIdx=(jd+1)%12;      // 0..11 -> T√Ω
  return { dayCan: CAN[canIdx], dayChi: CHI[chiIdx], dayCanIndex: canIdx+1 }; // 1..10
}
// Can Chi nƒÉm (d·ª±a nƒÉm √¢m)
function yearCanChi(lunarYear){
  const canIdx=((lunarYear+6)%10);    // 0..9
  const chiIdx=((lunarYear+8)%12);    // 0..11
  return { yearCan: CAN[canIdx], yearChi: CHI[chiIdx], yearCanIndex: canIdx+1 };
}
// Can Chi th√°ng: d√πng TH√ÅNG √ÇM; Chi: 1=D·∫ßn cho th√°ng 1; Can: ph·ª• thu·ªôc can nƒÉm, m·ªói th√°ng +1
function monthCanChi(lunarMonth, yearCanIndex){
  // base stem cho th√°ng 1 (D·∫ßn) theo can nƒÉm:
  // Gi√°p/K·ª∑‚ÜíB√≠nh(3), ·∫§t/Canh‚ÜíM·∫≠u(5), B√≠nh/T√¢n‚ÜíCanh(7), ƒêinh/Nh√¢m‚ÜíNh√¢m(9), M·∫≠u/Qu√Ω‚ÜíGi√°p(1)
  let base;
  if(yearCanIndex===1||yearCanIndex===6) base=3;
  else if(yearCanIndex===2||yearCanIndex===7) base=5;
  else if(yearCanIndex===3||yearCanIndex===8) base=7;
  else if(yearCanIndex===4||yearCanIndex===9) base=9;
  else base=1; // 5 or 10
  const stemIdx = mod1(base + (lunarMonth-1), 10);          // 1..10
  const branchIdx = mod1(lunarMonth + 2, 12);               // 1..12 (1->D·∫ßn=3rd chi)
  return { monthCan: CAN[stemIdx-1], monthChi: CHI[branchIdx-1] };
}
// Can Chi gi·ªù: d·ª±a CAN ng√†y + CHI gi·ªù
function hourCanChi(dayCanIndex, hourBranchIdx){
  let base; // can c·ªßa gi·ªù T√Ω khi bi·∫øt can ng√†y
  if(dayCanIndex===1||dayCanIndex===6) base=1;      // Gi√°p/K·ª∑ -> T√Ω gi·ªù Gi√°p
  else if(dayCanIndex===2||dayCanIndex===7) base=3; // ·∫§t/Canh -> T√Ω gi·ªù B√≠nh
  else if(dayCanIndex===3||dayCanIndex===8) base=5; // B√≠nh/T√¢n -> T√Ω gi·ªù M·∫≠u
  else if(dayCanIndex===4||dayCanIndex===9) base=7; // ƒêinh/Nh√¢m -> T√Ω gi·ªù Canh
  else base=9;                                      // M·∫≠u/Qu√Ω -> T√Ω gi·ªù Nh√¢m
  const stemIdx = mod1(base + (hourBranchIdx-1), 10);
  return { hourCan: CAN[stemIdx-1], hourChi: CHI[hourBranchIdx-1] };
}

// ===== T√≠nh qu·∫ª + Can Chi =====
function calc(){
  const solar=document.getElementById("solarDate").value;
  const time=document.getElementById("solarTime").value;
  if(!solar){alert("Ch·ªçn ng√†y!");return;}
  const [y,m,d]=solar.split("-").map(Number);
  const [hh,mm]=time.split(":").map(Number);
  const iana=document.getElementById("iana").value;
  const useVN=document.getElementById("vnStd").checked;
  const tz=useVN?7:offsetHoursAt(iana,y,m,d,hh,mm);

  // √Çm l·ªãch theo m√∫i gi·ªù (DST-safe)
  const [dayAm,monthAm,yearAm,leap]=AmLich.convertSolar2Lunar(d,m,y,tz);

  // Can‚ÄìChi
  const {dayCan, dayChi, dayCanIndex}=dayCanChi(d,m,y); // ng√†y theo l·ªãch ƒë·ªãa ph∆∞∆°ng ng∆∞·ªùi d√πng ƒë√£ nh·∫≠p
  const {yearCan, yearChi, yearCanIndex}=yearCanChi(yearAm);
  const {monthCan, monthChi}=monthCanChi(monthAm, yearCanIndex);
  const chiHourIdx=chiIndexFromHour(hh);
  const {hourCan, hourChi}=hourCanChi(dayCanIndex, chiHourIdx);

  // Qu·∫ª ch·ªß
  const upper=mod1(monthAm+dayAm,8);
  const lower=mod1(dayAm+chiHourIdx,8);
  const moving=mod1(monthAm+dayAm+chiHourIdx,6);
  const lines=buildHex(lower,upper);
  const mainName=getHexName(upper,lower);

  // Qu·∫ª bi·∫øn
  const changed=mutate(lines,moving);
  const lower2=trigramIndex(changed.slice(0,3));
  const upper2=trigramIndex(changed.slice(3,6));
  const changeName=getHexName(upper2,lower2);

  // Output
  let out=`Ng√†y d∆∞∆°ng: ${d}/${m}/${y} ${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}\n`;
  out+=`√Çm l·ªãch: ${dayAm}/${monthAm}${leap?" (nhu·∫≠n)":""}/${yearAm}\n`;
  out+=`M√∫i gi·ªù: ${useVN?"VN (UTC+7)":iana} (offset ${tz})\n\n`;
  out+=`üïì Can Chi:\n`;
  out+=`  Gi·ªù: ${hourCan} ${hourChi}\n`;
  out+=`  Ng√†y: ${dayCan} ${dayChi}\n`;
  out+=`  Th√°ng: ${monthCan} ${monthChi}\n`;
  out+=`  NƒÉm: ${yearCan} ${yearChi}\n\n`;
  out+=`üîπ Qu·∫ª ch·ªß: ${mainName[1]} (${mainName[2]})\n${render(lines,moving)}\n`;
  out+=`üî∏ Qu·∫ª bi·∫øn: ${changeName[1]} (${changeName[2]})\n${render(changed,0)}`;
  document.getElementById("out").textContent=out;
}
</script>
</body>
</html>
