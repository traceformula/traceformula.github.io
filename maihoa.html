<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Mai Hoa Dá»‹ch Sá»‘ â€“ DST-safe (Ã‚m lá»‹ch chuáº©n)</title>

<!-- Ã‚m lá»‹ch Ä‘áº§y Ä‘á»§ (offline) -->
<script>
var AmLich={INT:Math.floor,jdFromDate:function(d,m,y){var a=this.INT((14-m)/12);var yy=y+4800-a;var mm=m+12*a-3;var jd=d+this.INT((153*mm+2)/5)+365*yy+this.INT(yy/4)-this.INT(yy/100)+this.INT(yy/400)-32045;if(jd<2299161)jd=d+this.INT((153*mm+2)/5)+365*yy+this.INT(yy/4)-32083;return jd},NewMoon:function(k){var T=k/1236.85,T2=T*T,T3=T2*T,dr=Math.PI/180;var Jd1=2415020.75933+29.53058868*k+0.0001178*T2-0.000000155*T3;Jd1+=0.00033*Math.sin((166.56+132.87*T-0.009173*T2)*dr);var M=359.2242+29.10535608*k-0.0000333*T2-0.00000347*T3;var Mpr=306.0253+385.81691806*k+0.0107306*T2+0.00001236*T3;var F=21.2964+390.67050646*k-0.0016528*T2-0.00000239*T3;var C1=(0.1734-0.000393*T)*Math.sin(M*dr)+0.0021*Math.sin(2*M*dr)-0.4068*Math.sin(Mpr*dr)+0.0161*Math.sin(2*Mpr*dr)+0.0104*Math.sin(2*F*dr)-0.0051*Math.sin((M+Mpr)*dr);var deltat=T<-11?0.001+0.000839*T+0.0002261*T2-0.00000845*T3-0.000000081*T*T3:-0.000278+0.000265*T+0.000262*T2;return Jd1+C1-deltat},SunLongitude:function(jdn){var T=(jdn-2451545.0)/36525;var dr=Math.PI/180;var M=357.52910+35999.05030*T-0.0001559*T*T-0.00000048*T*T*T;var L0=280.46645+36000.76983*T+0.0003032*T*T;var DL=(1.914600-0.004817*T-0.000014*T*T)*Math.sin(dr*M)+(0.019993-0.000101*T)*Math.sin(2*dr*M)+0.000290*Math.sin(3*dr*M);var L=L0+DL;L=L*dr;L=L-2*Math.PI*Math.floor(L/(2*Math.PI));return L},getSunLongitude:function(dayNumber,timeZone){return Math.floor(this.SunLongitude(dayNumber-0.5-timeZone/24)/Math.PI*6)},getNewMoonDay:function(k,tz){return Math.floor(this.NewMoon(k)+0.5+tz/24)},getLunarMonth11:function(yy,tz){var off=this.jdFromDate(31,12,yy)-2415021;var k=Math.floor(off/29.530588853);var nm=this.getNewMoonDay(k,tz);var sunLong=this.getSunLongitude(nm,tz);if(sunLong>=9)nm=this.getNewMoonDay(k-1,tz);return nm},getLeapMonthOffset:function(a11,tz){var k=Math.floor((a11-2415021.076998695)/29.530588853+0.5);var last,arc=this.getSunLongitude(this.getNewMoonDay(k+1,tz),tz);var i=1;do{last=arc;i++;arc=this.getSunLongitude(this.getNewMoonDay(k+i,tz),tz);}while(arc!=last&&i<14);return i-1},convertSolar2Lunar:function(dd,mm,yy,tz){var dayNumber=this.jdFromDate(dd,mm,yy);var k=Math.floor((dayNumber-2415021.076998695)/29.530588853);var monthStart=this.getNewMoonDay(k+1,tz);if(monthStart>dayNumber)monthStart=this.getNewMoonDay(k,tz);var a11=this.getLunarMonth11(yy,tz);var b11=a11,lunarYear;if(a11>=monthStart){a11=this.getLunarMonth11(yy-1,tz);lunarYear=yy;}else{b11=this.getLunarMonth11(yy+1,tz);lunarYear=yy+1;}var lunarDay=dayNumber-monthStart+1;var diff=Math.floor((monthStart-a11)/29);var lunarLeap=0,lunarMonth=diff+11;if(b11-a11>365){var leapMonthDiff=this.getLeapMonthOffset(a11,tz);if(diff>=leapMonthDiff){lunarMonth=diff+10;if(diff==leapMonthDiff)lunarLeap=1;}}if(lunarMonth>12)lunarMonth-=12;if(lunarMonth>=11&&diff<4)lunarYear-=1;return[lunarDay,lunarMonth,lunarYear,lunarLeap];}};
</script>
</head>
<body>
<h2>ğŸ”® Mai Hoa Dá»‹ch Sá»‘ â€“ DST safe</h2>

<label>NgÃ y dÆ°Æ¡ng: <input type="date" id="solarDate" /></label><br/>
<label>Giá» (hh:mm): <input type="time" id="solarTime" value="01:23" /></label><br/>
<label>MÃºi giá» (IANA):
  <select id="iana">
    <option value="Asia/Ho_Chi_Minh">Asia/Ho_Chi_Minh (VN)</option>
    <option value="America/New_York">America/New_York (NY)</option>
    <option value="America/Los_Angeles">America/Los_Angeles (CA)</option>
  </select>
</label>
<label style="margin-left:8px;">
  <input type="checkbox" id="vnStd" /> DÃ¹ng chuáº©n lá»‹ch VN (UTC+7)
</label>
<br/>
<button onclick="calcHexagram()">Láº­p quáº»</button>

<pre id="output"></pre>

<script>
// ===== BÃ¡t quÃ¡i & 64 quáº» =====
const TRIGRAMS={1:{vn:"CÃ n",symbol:"â˜°",lines:[1,1,1]},2:{vn:"ÄoÃ i",symbol:"â˜±",lines:[1,1,0]},3:{vn:"Ly",symbol:"â˜²",lines:[1,0,1]},4:{vn:"Cháº¥n",symbol:"â˜³",lines:[1,0,0]},5:{vn:"Tá»‘n",symbol:"â˜´",lines:[0,1,1]},6:{vn:"Kháº£m",symbol:"â˜µ",lines:[0,1,0]},7:{vn:"Cáº¥n",symbol:"â˜¶",lines:[0,0,1]},8:{vn:"KhÃ´n",symbol:"â˜·",lines:[0,0,0]}};
const HEX_NAMES=[[],["CÃ n","CÃ n Vi ThiÃªn","ä¹¾ç‚ºå¤©"],["CÃ n","Phong ThiÃªn Tiá»ƒu SÃºc","é¢¨å¤©å°ç•œ"],["CÃ n","Há»a ThiÃªn Äáº¡i Há»¯u","ç«å¤©å¤§æœ‰"],["CÃ n","Tráº¡ch ThiÃªn Quáº£i","æ¾¤å¤©å¤¬"],["CÃ n","SÆ¡n ThiÃªn Äáº¡i SÃºc","å±±å¤©å¤§ç•œ"],["CÃ n","Thá»§y ThiÃªn Nhu","æ°´å¤©éœ€"],["CÃ n","LÃ´i ThiÃªn Äáº¡i TrÃ¡ng","é›·å¤©å¤§å£¯"],["CÃ n","Äá»‹a ThiÃªn ThÃ¡i","åœ°å¤©æ³°"],["ÄoÃ i","ThiÃªn Tráº¡ch LÃ½","å¤©æ¾¤å±¥"],["ÄoÃ i","Phong Tráº¡ch Trung Phu","é¢¨æ¾¤ä¸­å­š"],["ÄoÃ i","Há»a Tráº¡ch KhuÃª","ç«æ¾¤ç½"],["ÄoÃ i","Tráº¡ch Vi ÄoÃ i","å…Œç‚ºæ¾¤"],["ÄoÃ i","SÆ¡n Tráº¡ch Tá»•n","å±±æ¾¤æ"],["ÄoÃ i","Thá»§y Tráº¡ch Tiáº¿t","æ°´æ¾¤ç¯€"],["ÄoÃ i","LÃ´i Tráº¡ch Quy Muá»™i","é›·æ¾¤æ­¸å¦¹"],["ÄoÃ i","Äá»‹a Tráº¡ch LÃ¢m","åœ°æ¾¤è‡¨"],["Ly","ThiÃªn Há»a Äá»“ng NhÃ¢n","å¤©ç«åŒäºº"],["Ly","Phong Há»a Gia NhÃ¢n","é¢¨ç«å®¶äºº"],["Ly","Ly Vi Há»a","é›¢ç‚ºç«"],["Ly","Tráº¡ch Há»a CÃ¡ch","æ¾¤ç«é©"],["Ly","SÆ¡n Há»a BÃ­","å±±ç«è³"],["Ly","Thá»§y Há»a KÃ½ Táº¿","æ°´ç«æ—¢æ¿Ÿ"],["Ly","LÃ´i Há»a Phong","é›·ç«è±"],["Ly","Äá»‹a Há»a Minh Di","åœ°ç«æ˜å¤·"],["Cháº¥n","ThiÃªn LÃ´i VÃ´ Vá»ng","å¤©é›·æ— å¦„"],["Cháº¥n","Phong LÃ´i Ãch","é¢¨é›·ç›Š"],["Cháº¥n","Há»a LÃ´i Phá»‡ Háº¡p","ç«é›·å™¬å—‘"],["Cháº¥n","Tráº¡ch LÃ´i TÃ¹y","æ¾¤é›·éš¨"],["Cháº¥n","SÆ¡n LÃ´i Di","å±±é›·é ¤"],["Cháº¥n","Thá»§y LÃ´i TruÃ¢n","æ°´é›·å±¯"],["Cháº¥n","Cháº¥n Vi LÃ´i","éœ‡ç‚ºé›·"],["Cháº¥n","Äá»‹a LÃ´i Phá»¥c","åœ°é›·å¾©"],["Tá»‘n","ThiÃªn Phong Cáº¥u","å¤©é¢¨å§¤"],["Tá»‘n","Tá»‘n Vi Phong","å·½ç‚ºé¢¨"],["Tá»‘n","Há»a Phong Äá»‰nh","ç«é¢¨é¼"],["Tá»‘n","Tráº¡ch Phong Äáº¡i QuÃ¡","æ¾¤é¢¨å¤§é"],["Tá»‘n","SÆ¡n Phong Cá»•","å±±é¢¨è ±"],["Tá»‘n","Thá»§y Phong Tá»‰nh","æ°´é¢¨äº•"],["Tá»‘n","LÃ´i Phong Háº±ng","é›·é¢¨æ†"],["Tá»‘n","Äá»‹a Phong ThÄƒng","åœ°é¢¨å‡"],["Kháº£m","ThiÃªn Thá»§y Tá»¥ng","å¤©æ°´è¨Ÿ"],["Kháº£m","Phong Thá»§y HoÃ¡n","é¢¨æ°´æ¸™"],["Kháº£m","Há»a Thá»§y Vá»‹ Táº¿","ç«æ°´æœªæ¿Ÿ"],["Kháº£m","Tráº¡ch Thá»§y Khá»‘n","æ¾¤æ°´å›°"],["Kháº£m","SÆ¡n Thá»§y MÃ´ng","å±±æ°´è’™"],["Kháº£m","Kháº£m Vi Thá»§y","åç‚ºæ°´"],["Kháº£m","LÃ´i Thá»§y Giáº£i","é›·æ°´è§£"],["Kháº£m","Äá»‹a Thá»§y SÆ°","åœ°æ°´å¸«"],["Cáº¥n","ThiÃªn SÆ¡n Äá»™n","å¤©å±±é¯"],["Cáº¥n","Phong SÆ¡n Tiá»‡m","é¢¨å±±æ¼¸"],["Cáº¥n","Há»a SÆ¡n Lá»¯","ç«å±±æ—…"],["Cáº¥n","Tráº¡ch SÆ¡n HÃ m","æ¾¤å±±å’¸"],["Cáº¥n","Cáº¥n Vi SÆ¡n","è‰®ç‚ºå±±"],["Cáº¥n","Thá»§y SÆ¡n Kiá»ƒn","æ°´å±±è¹‡"],["Cáº¥n","LÃ´i SÆ¡n Tiá»ƒu QuÃ¡","é›·å±±å°é"],["Cáº¥n","Äá»‹a SÆ¡n KhiÃªm","åœ°å±±è¬™"],["KhÃ´n","ThiÃªn Äá»‹a BÄ©","å¤©åœ°å¦"],["KhÃ´n","Phong Äá»‹a Quan","é¢¨åœ°è§€"],["KhÃ´n","Há»a Äá»‹a Táº¥n","ç«åœ°æ™‰"],["KhÃ´n","Tráº¡ch Äá»‹a Tá»¥y","æ¾¤åœ°èƒ"],["KhÃ´n","SÆ¡n Äá»‹a BÃ¡c","å±±åœ°å‰"],["KhÃ´n","Thá»§y Äá»‹a Tá»·","æ°´åœ°æ¯”"],["KhÃ´n","LÃ´i Äá»‹a Dá»±","é›·åœ°è±«"],["KhÃ´n","KhÃ´n Vi Äá»‹a","å¤ç‚ºåœ°"]];

// Äá»•i giá» â†’ chi
function chiIndexFromHour(h){if(h===23||h===0)return 1;if(h<=2)return 2;if(h<=4)return 3;if(h<=6)return 4;if(h<=8)return 5;if(h<=10)return 6;if(h<=12)return 7;if(h<=14)return 8;if(h<=16)return 9;if(h<=18)return 10;if(h<=20)return 11;return 12;}
const mod1=(x,m)=>{const r=x%m;return r===0?m:r;}
const buildHex=(lower,upper)=>[...TRIGRAMS[lower].lines,...TRIGRAMS[upper].lines];
const mutate=(lines,m)=>{const o=[...lines];o[m-1]=o[m-1]?0:1;return o;}
const render=(lines,m)=>{const s=v=>v?"â”€â”€â”€â”€â”€â”€â”€":"â”€â”€ â”€â”€";let t="";for(let i=6;i>=1;i--){t+=i+" | "+s(lines[i-1]);if(i===m)t+=" â‡¢ Ä‘á»™ng";t+="\n";}return t;}
const getHexName=(up,lo)=>HEX_NAMES[(up-1)*8+lo];

// Láº¥y offset giá» (cÃ³ DST) cho IANA + ngÃ y/giá» Ä‘Ã£ chá»n
function offsetHoursAt(iana, y,m,d,hh,mm){
  // DÃ¹ng timeZoneName='shortOffset' Ä‘á»ƒ láº¥y GMTÂ±hh[:mm]
  const dtUTC = new Date(Date.UTC(y,m-1,d,hh,mm,0));
  const fmt = new Intl.DateTimeFormat("en-US",{
    timeZone: iana, timeZoneName:"shortOffset",
    year:"2-digit", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", hour12:false
  });
  const s = fmt.format(dtUTC); // e.g. "10/05/25, 21:23 GMT-04"
  const m1 = s.match(/GMT([+-]\d{2})(?::?(\d{2}))?/i);
  if(!m1) return 0;
  const h = parseInt(m1[1],10);
  const mi = m1[2]? parseInt(m1[2],10):0;
  return h + (h>=0? mi/60 : -mi/60);
}

function trigramIndex(bits){
  for(let i=1;i<=8;i++){
    const t=TRIGRAMS[i].lines;
    if(t[0]===bits[0] && t[1]===bits[1] && t[2]===bits[2]) return i;
  }
  return 1;
}

function calcHexagram(){
  const solar = document.getElementById("solarDate").value;
  const time  = document.getElementById("solarTime").value;
  if(!solar){alert("Chá»n ngÃ y!");return;}
  const [y,m,d]=solar.split("-").map(Number);
  const [hh,mm]=time.split(":").map(Number);
  const iana = document.getElementById("iana").value;
  const useVN = document.getElementById("vnStd").checked;

  // Offset giá» cho Ã¢m lá»‹ch
  const tzHours = useVN ? 7 : offsetHoursAt(iana, y,m,d,hh,mm);

  // Ã‚m lá»‹ch (chuáº©n ngÃ y/giá» chá»n + DST)
  const [dayAm,monthAm,yearAm,leap] = AmLich.convertSolar2Lunar(d,m,y,tzHours);

  // Quáº» chá»§
  const chi = chiIndexFromHour(hh);
  const up  = mod1(monthAm+dayAm,8);
  const lo  = mod1(dayAm+chi,8);
  const mov = mod1(monthAm+dayAm+chi,6);
  const lines = buildHex(lo,up);
  const mainName = getHexName(up,lo);

  // Quáº» biáº¿n (tÃ­nh láº¡i thÆ°á»£ng/háº¡ sau khi Ä‘áº£o hÃ o)
  const changed = mutate(lines,mov);
  const lo2 = trigramIndex(changed.slice(0,3));
  const up2 = trigramIndex(changed.slice(3,6));
  const changeName = getHexName(up2,lo2);

  let out = `NgÃ y dÆ°Æ¡ng: ${d}/${m}/${y} ${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}\n`;
  out += `Ã‚m lá»‹ch: ${dayAm}/${monthAm}${leap?" (nhuáº­n)":""}/${yearAm}\n`;
  out += `MÃºi giá»: ${useVN?"VN chuáº©n (+7)":iana} â†’ offset ${tzHours}\n`;
  out += `Giá» Ä‘á»‹a chi: ${chi}\n\n`;
  out += `ğŸ”¹ Quáº» chá»§: ${mainName[1]} (${mainName[2]})\n` + render(lines,mov);
  out += `\nğŸ”¸ Quáº» biáº¿n: ${changeName[1]} (${changeName[2]})\n` + render(changed,0);
  document.getElementById("output").textContent = out;
}
</script>
</body>
</html>
