<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Mai Hoa Dá»‹ch Sá»‘ â€“ Thiá»‡u Khang Tiáº¿t</title>
<style>
body { font-family: "Segoe UI", sans-serif; background:#fefefe; padding:20px; line-height:1.5; }
label { display:block; margin:6px 0; }
pre { background:#fff; border:1px solid #ccc; border-radius:8px; padding:12px; white-space:pre-wrap; }
button { padding:8px 14px; cursor:pointer; margin-top:8px; border-radius:5px; background:#eee; }
</style>
<script>
// ================= Ã‚m Lá»‹ch =================
var AmLich={INT:Math.floor,jdFromDate:function(d,m,y){var a=this.INT((14-m)/12);var yy=y+4800-a;var mm=m+12*a-3;var jd=d+this.INT((153*mm+2)/5)+365*yy+this.INT(yy/4)-this.INT(yy/100)+this.INT(yy/400)-32045;if(jd<2299161)jd=d+this.INT((153*mm+2)/5)+365*yy+this.INT(yy/4)-32083;return jd},NewMoon:function(k){var T=k/1236.85,T2=T*T,T3=T2*T,dr=Math.PI/180;var Jd1=2415020.75933+29.53058868*k+0.0001178*T2-0.000000155*T3;Jd1+=0.00033*Math.sin((166.56+132.87*T-0.009173*T2)*dr);var M=359.2242+29.10535608*k-0.0000333*T2-0.00000347*T3;var Mpr=306.0253+385.81691806*k+0.0107306*T2+0.00001236*T3;var F=21.2964+390.67050646*k-0.0016528*T2-0.00000239*T3;var C1=(0.1734-0.000393*T)*Math.sin(M*dr)+0.0021*Math.sin(2*M*dr)-0.4068*Math.sin(Mpr*dr)+0.0161*Math.sin(2*Mpr*dr)+0.0104*Math.sin(2*F*dr)-0.0051*Math.sin((M+Mpr)*dr);var deltat=T<-11?0.001+0.000839*T+0.0002261*T2-0.00000845*T3-0.000000081*T*T3:-0.000278+0.000265*T+0.000262*T2;return Jd1+C1-deltat},getNewMoonDay:function(k,tz){return Math.floor(this.NewMoon(k)+0.5+tz/24)},getSunLongitude:function(jdn,tz){var T=(jdn-2451545.0)/36525;var dr=Math.PI/180;var M=357.52910+35999.05030*T-0.0001559*T*T-0.00000048*T*T*T;var L0=280.46645+36000.76983*T+0.0003032*T*T;var DL=(1.914600-0.004817*T-0.000014*T*T)*Math.sin(dr*M)+(0.019993-0.000101*T)*Math.sin(2*dr*M)+0.000290*Math.sin(3*dr*M);var L=L0+DL;L=L*dr;L=L-2*Math.PI*Math.floor(L/(2*Math.PI));return Math.floor(L/Math.PI*6)},getLunarMonth11:function(yy,tz){var off=this.jdFromDate(31,12,yy)-2415021;var k=Math.floor(off/29.530588853);var nm=this.getNewMoonDay(k,tz);if(this.getSunLongitude(nm,tz)>=9)nm=this.getNewMoonDay(k-1,tz);return nm},getLeapMonthOffset:function(a11,tz){var k=Math.floor((a11-2415021.076998695)/29.530588853+0.5);var last,arc=this.getSunLongitude(this.getNewMoonDay(k+1,tz),tz);var i=1;do{last=arc;i++;arc=this.getSunLongitude(this.getNewMoonDay(k+i,tz),tz);}while(arc!=last&&i<14);return i-1},convertSolar2Lunar:function(dd,mm,yy,tz){var dayNumber=this.jdFromDate(dd,mm,yy);var k=Math.floor((dayNumber-2415021.076998695)/29.530588853);var monthStart=this.getNewMoonDay(k+1,tz);if(monthStart>dayNumber)monthStart=this.getNewMoonDay(k,tz);var a11=this.getLunarMonth11(yy,tz);var b11=a11,lunarYear;if(a11>=monthStart){a11=this.getLunarMonth11(yy-1,tz);lunarYear=yy;}else{b11=this.getLunarMonth11(yy+1,tz);lunarYear=yy+1;}var lunarDay=dayNumber-monthStart+1;var diff=Math.floor((monthStart-a11)/29);var lunarLeap=0,lunarMonth=diff+11;if(b11-a11>365){var leapMonthDiff=this.getLeapMonthOffset(a11,tz);if(diff>=leapMonthDiff){lunarMonth=diff+10;if(diff==leapMonthDiff)lunarLeap=1;}}if(lunarMonth>12)lunarMonth-=12;if(lunarMonth>=11&&diff<4)lunarYear-=1;return[lunarDay,lunarMonth,lunarYear,lunarLeap];}};
</script>
</head>
<body>
<h2>ğŸŒ¸ Mai Hoa Dá»‹ch Sá»‘ â€“ Thiá»‡u Khang Tiáº¿t</h2>
<label>NgÃ y dÆ°Æ¡ng: <input type="date" id="solarDate"></label>
<label>Giá» (hh:mm): <input type="time" id="solarTime" value="01:46"></label>
<label>MÃºi giá»:
  <select id="iana">
    <option value="Asia/Ho_Chi_Minh">Asia/Ho_Chi_Minh (VN)</option>
    <option value="America/New_York">America/New_York</option>
  </select>
</label>
<label><input type="checkbox" id="vnStd" checked> DÃ¹ng chuáº©n VN (UTC+7)</label>
<label>PhÆ°Æ¡ng Ã¡n:
  <select id="variant">
    <option value="B" selected>PhÆ°Æ¡ng Ã¡n B (Thiá»‡u Khang Tiáº¿t)</option>
    <option value="A">PhÆ°Æ¡ng Ã¡n A (thÃ´ng thÆ°á»ng)</option>
  </select>
</label>
<div id="explain" style="font-size:14px; background:#f8f8f8; border-left:4px solid #999; padding:8px 12px; margin:8px 0; line-height:1.5;">
  <b>ğŸ§­ Giáº£i thÃ­ch:</b><br>
  â€¢ <b>PhÆ°Æ¡ng Ã¡n A (phá»• thÃ´ng)</b>:<br>
  &nbsp;&nbsp;â€“ ThÆ°á»£ng quÃ¡i = (thÃ¡ng + ngÃ y) mod 8<br>
  &nbsp;&nbsp;â€“ Háº¡ quÃ¡i = (ngÃ y + giá») mod 8<br>
  &nbsp;&nbsp;â€“ HÃ o Ä‘á»™ng = (thÃ¡ng + ngÃ y + giá») mod 6<br>
  ğŸ‘‰ Dá»… hiá»ƒu, phá»• biáº¿n trong cÃ¡c sÃ¡ch Dá»‹ch há»c hiá»‡n Ä‘áº¡i.<br><br>

  â€¢ <b>PhÆ°Æ¡ng Ã¡n B (Thiá»‡u Khang Tiáº¿t â€“ Mai Hoa chuáº©n)</b>:<br>
  &nbsp;&nbsp;â€“ ThÆ°á»£ng quÃ¡i = (thÃ¡ng + giá») mod 8<br>
  &nbsp;&nbsp;â€“ Háº¡ quÃ¡i = (ngÃ y + thÃ¡ng) mod 8<br>
  &nbsp;&nbsp;â€“ HÃ o Ä‘á»™ng = (thÃ¡ng + ngÃ y + giá») mod 6<br>
  ğŸ‘‰ Nháº¥n máº¡nh â€œthiÃªn â€“ nhÃ¢n â€“ Ä‘á»‹aâ€ phá»‘i há»£p (thiÃªn thá»i lÃ  thÃ¡ng, nhÃ¢n lÃ  ngÃ y, Ä‘á»‹a lÃ  giá»).<br>
  DÃ¹ng cho Mai Hoa Dá»‹ch Sá»‘ nguyÃªn báº£n cá»§a Thiá»‡u Khang Tiáº¿t (Báº¯c Tá»‘ng).<br><br>
  ğŸ’¡ <i>PhÆ°Æ¡ng Ã¡n B</i> thÆ°á»ng cho káº¿t quáº£ â€œthuáº§n dá»‹ch lÃ½â€ vÃ  tÆ°Æ¡ng thÃ­ch vá»›i báº£n Ä‘á»“ quáº» trong Thiá»‡u tiÃªn sinh,  
  cÃ²n <i>phÆ°Æ¡ng Ã¡n A</i> dÃ¹ng thuáº­n tiá»‡n hÆ¡n trong cÃ¡c há»‡ giáº£n hÃ³a hiá»‡n Ä‘áº¡i.
</div>
<button onclick="calc()">Láº­p quáº»</button>
<pre id="out"></pre>

<script>
const CAN=["GiÃ¡p","áº¤t","BÃ­nh","Äinh","Máº­u","Ká»·","Canh","TÃ¢n","NhÃ¢m","QuÃ½"];
const CHI=["TÃ½","Sá»­u","Dáº§n","MÃ£o","ThÃ¬n","Tá»µ","Ngá»","MÃ¹i","ThÃ¢n","Dáº­u","Tuáº¥t","Há»£i"];
const mod1=(x,m)=>{const r=x%m;return r===0?m:r;}
const TRIGRAMS={1:{vn:"CÃ n",lines:[1,1,1]},2:{vn:"ÄoÃ i",lines:[1,1,0]},3:{vn:"Ly",lines:[1,0,1]},4:{vn:"Cháº¥n",lines:[1,0,0]},5:{vn:"Tá»‘n",lines:[0,1,1]},6:{vn:"Kháº£m",lines:[0,1,0]},7:{vn:"Cáº¥n",lines:[0,0,1]},8:{vn:"KhÃ´n",lines:[0,0,0]}};

// Ãnh xáº¡ Thiá»‡u Khang Tiáº¿t
const MAP_B_UPPER=[null,1,8,4,5,6,3,7,2];
const MAP_B_LOWER=[null,1,2,3,4,5,6,7,8];
const MAP_A_UPPER=[null,1,2,3,4,5,6,7,8];
const MAP_A_LOWER=[null,1,2,3,4,5,6,7,8];

function chiIndexFromHour(h){if(h===23||h===0)return 1;if(h<=2)return 2;if(h<=4)return 3;if(h<=6)return 4;if(h<=8)return 5;if(h<=10)return 6;if(h<=12)return 7;if(h<=14)return 8;if(h<=16)return 9;if(h<=18)return 10;if(h<=20)return 11;return 12;}
function offsetHoursAt(iana,y,m,d,hh,mm){const dtUTC=new Date(Date.UTC(y,m-1,d,hh,mm));const fmt=new Intl.DateTimeFormat("en-US",{timeZone:iana,timeZoneName:"shortOffset"});const s=fmt.format(dtUTC);const m1=s.match(/GMT([+-]\d{2})(?::?(\d{2}))?/);if(!m1)return 0;const h=parseInt(m1[1]);const mi=m1[2]?parseInt(m1[2]):0;return h+(h>=0?mi/60:-mi/60);}
const build=(l,u)=>[...TRIGRAMS[l].lines,...TRIGRAMS[u].lines];
const mutate=(arr,i)=>{const o=[...arr];o[i-1]=o[i-1]?0:1;return o;}
//const render=(lines,m)=>{const s=v=>v?"â”€â”€â”€â”€â”€â”€â”€":"â”€â”€ â”€â”€";let t="";for(let i=6;i>=1;i--){t+=i+" | "+s(lines[i-1]);if(i===m)t+=" â‡¢ Ä‘á»™ng";t+="\n";}return t;}

function render(lines, moving) {
  const s = v => v ? "â”€â”€â”€â”€â”€â”€â”€" : "â”€â”€ â”€â”€";
  let t = "";
  // Váº½ tá»« hÃ o 1 (dÆ°á»›i) lÃªn hÃ o 6 (trÃªn)
  for (let i = 1; i <= 6; i++) {
    t += i + " | " + s(lines[i - 1]);
    if (i === moving) t += " â‡¢ Ä‘á»™ng";
    t += "\n";
  }
  return t;
}

function trigramIndex(bits){for(let i=1;i<=8;i++){const t=TRIGRAMS[i].lines;if(t[0]===bits[0]&&t[1]===bits[1]&&t[2]===bits[2])return i;}return 1;}

// Can Chi
function dayCanChi(dd,mm,yy){const jd=AmLich.jdFromDate(dd,mm,yy);const canIdx=(jd+9)%10;const chiIdx=(jd+1)%12;return {dayCan:CAN[canIdx],dayChi:CHI[chiIdx],dayCanIndex:canIdx+1};}
function yearCanChi(lunarYear){const canIdx=(lunarYear+6)%10,chiIdx=(lunarYear+8)%12;return {yearCan:CAN[canIdx],yearChi:CHI[chiIdx],yearCanIndex:canIdx+1};}
function monthCanChi(lunarMonth,yearCanIndex){let base;if(yearCanIndex===1||yearCanIndex===6)base=3;else if(yearCanIndex===2||yearCanIndex===7)base=5;else if(yearCanIndex===3||yearCanIndex===8)base=7;else if(yearCanIndex===4||yearCanIndex===9)base=9;else base=1;const stemIdx=mod1(base+(lunarMonth-1),10);const branchIdx=mod1(lunarMonth+2,12);return {monthCan:CAN[stemIdx-1],monthChi:CHI[branchIdx-1]};}
function hourCanChi(dayCanIndex,hourBranchIdx){let base;if(dayCanIndex===1||dayCanIndex===6)base=1;else if(dayCanIndex===2||dayCanIndex===7)base=3;else if(dayCanIndex===3||dayCanIndex===8)base=5;else if(dayCanIndex===4||dayCanIndex===9)base=7;else base=9;const stemIdx=mod1(base+(hourBranchIdx-1),10);return {hourCan:CAN[stemIdx-1],hourChi:CHI[hourBranchIdx-1]};}

// 64 Quáº»
const HEX_NAMES=[[],
["CÃ n Vi ThiÃªn","ä¹¾ç‚ºå¤©","Thuáº§n dÆ°Æ¡ng, sÃ¡ng suá»‘t, tá»± cÆ°á»ng, Ä‘áº¡i cÃ¡t."],
["Phong ThiÃªn Tiá»ƒu SÃºc","é¢¨å¤©å°ç•œ","TÃ­ch tá»¥ nhá», chá» thá»i, thuáº­n trung."],
["Há»a ThiÃªn Äáº¡i Há»¯u","ç«å¤©å¤§æœ‰","Äáº¡i phÃº, thá»‹nh vÆ°á»£ng, cÃ³ danh vá»ng."],
["Tráº¡ch ThiÃªn Quáº£i","æ¾¤å¤©å¤¬","Quyáº¿t Ä‘oÃ¡n, dá»©t bá» Ä‘iá»u xáº¥u, thuáº­n lá»£i."],
["SÆ¡n ThiÃªn Äáº¡i SÃºc","å±±å¤©å¤§ç•œ","TÃ­ch Ä‘á»©c, tiá»m tÃ ng sá»©c máº¡nh, chá» thá»i cÆ¡."],
["Thá»§y ThiÃªn Nhu","æ°´å¤©éœ€","Chá» Ä‘á»£i thuáº­n thá»i, giá»¯ Ä‘áº¡o mÃ  thÃ nh."],
["LÃ´i ThiÃªn Äáº¡i TrÃ¡ng","é›·å¤©å¤§å£¯","CÆ°á»ng trÃ¡ng, tá»± tin, hÃ nh Ä‘á»™ng lá»›n."],
["Äá»‹a ThiÃªn ThÃ¡i","åœ°å¤©æ³°","Thá»i thÃ´ng suá»‘t, Ã¢m dÆ°Æ¡ng hÃ²a há»£p, Ä‘áº¡i cÃ¡t."],
["ThiÃªn Tráº¡ch LÃ½","å¤©æ¾¤å±¥","Cáº©n trá»ng, hÃ nh sá»± cÃ³ ká»· cÆ°Æ¡ng, giá»¯ Ä‘áº¡o trung dung."],
["Phong Tráº¡ch Trung Phu","é¢¨æ¾¤ä¸­å­š","ThÃ nh tÃ­n, trung thá»±c, Ä‘Æ°á»£c lÃ²ng ngÆ°á»i."],
["Há»a Tráº¡ch KhuÃª","ç«æ¾¤ç½","KhÃ¡c Ã½, Ä‘á»‘i nghá»‹ch, cáº§n hÃ²a giáº£i."],
["Tráº¡ch Vi ÄoÃ i","å…Œç‚ºæ¾¤","Vui váº», hÃ²a thuáº­n, thuáº­n lá»£i nhá»."],
["SÆ¡n Tráº¡ch Tá»•n","å±±æ¾¤æ","Giáº£m bá»›t, tiáº¿t cháº¿, Ä‘á»ƒ lÃ¢u bá»n."],
["Thá»§y Tráº¡ch Tiáº¿t","æ°´æ¾¤ç¯€","Tiáº¿t Ä‘á»™, biáº¿t dá»«ng, trÃ¡nh vÆ°á»£t giá»›i háº¡n."],
["LÃ´i Tráº¡ch Quy Muá»™i","é›·æ¾¤æ­¸å¦¹","Káº¿t há»£p sai thá»i, cáº©n trá»ng."],
["Äá»‹a Tráº¡ch LÃ¢m","åœ°æ¾¤è‡¨","CÃ³ ngÆ°á»i giÃºp, thá»i cÆ¡ Ä‘áº¿n, cÃ¡t."],
["ThiÃªn Há»a Äá»“ng NhÃ¢n","å¤©ç«åŒäºº","Äá»“ng lÃ²ng, Ä‘á»“ng chÃ­, Ä‘áº¡i cÃ¡t."],
["Phong Há»a Gia NhÃ¢n","é¢¨ç«å®¶äºº","Gia Ä‘áº¡o hÃ²a thuáº­n, trá»‹ nhÃ  cÃ³ phÃ©p."],
["Ly Vi Há»a","é›¢ç‚ºç«","SÃ¡ng suá»‘t, thÃ´ng minh, dá»… phÃ¢n tÃ¡n."],
["Tráº¡ch Há»a CÃ¡ch","æ¾¤ç«é©","Cáº£i cÃ¡ch, Ä‘á»•i má»›i, chuyá»ƒn thá»i váº­n."],
["SÆ¡n Há»a BÃ­","å±±ç«è³","Trang sá»©c, Ä‘áº¹p Ä‘áº½, thÃ­ch há»£p nhá»."],
["Thá»§y Há»a KÃ½ Táº¿","æ°´ç«æ—¢æ¿Ÿ","HoÃ n táº¥t, viá»‡c lá»›n thÃ nh, thuáº­n lá»£i."],
["LÃ´i Há»a Phong","é›·ç«è±","Thá»‹nh vÆ°á»£ng, sÃ¡ng rÃµ, dá»… tá»± mÃ£n."],
["Äá»‹a Há»a Minh Di","åœ°ç«æ˜å¤·","áº¨n minh, giá»¯ mÃ¬nh, trÃ¡nh nguy hiá»ƒm."],
["ThiÃªn LÃ´i VÃ´ Vá»ng","å¤©é›·æ— å¦„","Chá»› vá»ng Ä‘á»™ng, trÃ¡nh sai láº§m."],
["Phong LÃ´i Ãch","é¢¨é›·ç›Š","ÄÆ°á»£c lá»£i, tiáº¿n triá»ƒn, thÃªm tÃ i lá»™c."],
["Há»a LÃ´i Phá»‡ Háº¡p","ç«é›·å™¬å—‘","Giáº£i quyáº¿t, cÃ´ng chÃ­nh tháº¯ng."],
["Tráº¡ch LÃ´i TÃ¹y","æ¾¤é›·éš¨","TÃ¹y thuáº­n thá»i tháº¿, cÃ¡t."],
["SÆ¡n LÃ´i Di","å±±é›·é ¤","DÆ°á»¡ng Ä‘áº¡o, nuÃ´i chÃ­, láº¥y chÃ­nh mÃ  bá»n."],
["Thá»§y LÃ´i TruÃ¢n","æ°´é›·å±¯","Khá»Ÿi Ä‘áº§u gian nan, kiÃªn nháº«n vÆ°á»£t khÃ³."],
["Cháº¥n Vi LÃ´i","éœ‡ç‚ºé›·","Äá»™ng, khai má»Ÿ, nhÆ°ng chá»› nÃ³ng vá»™i."],
["Äá»‹a LÃ´i Phá»¥c","åœ°é›·å¾©","Phá»¥c há»“i, trá»Ÿ láº¡i chÃ­nh Ä‘áº¡o, cÃ¡t."],
["ThiÃªn Phong Cáº¥u","å¤©é¢¨å§¤","Báº¥t ngá» gáº·p gá»¡, nÃªn giá»¯ lá»…."],
["Tá»‘n Vi Phong","å·½ç‚ºé¢¨","Uyá»ƒn chuyá»ƒn, thuáº­n theo, hanh thÃ´ng."],
["Há»a Phong Äá»‰nh","ç«é¢¨é¼","Cáº£i cÃ¡ch, hÆ°ng thá»‹nh, Ä‘áº¡i cÃ¡t."],
["Tráº¡ch Phong Äáº¡i QuÃ¡","æ¾¤é¢¨å¤§é","QuÃ¡ má»©c, cáº§n tiáº¿t cháº¿, nguy cÆ¡ tiá»m áº©n."],
["SÆ¡n Phong Cá»•","å±±é¢¨è ±","Sá»­a lá»—i cÅ©, cáº£i hÃ³a, trung cÃ¡t."],
["Thá»§y Phong Tá»‰nh","æ°´é¢¨äº•","Nguá»“n gá»‘c bá»n, nhÃ¢n nghÄ©a, á»•n Ä‘á»‹nh."],
["LÃ´i Phong Háº±ng","é›·é¢¨æ†","Bá»n lÃ¢u, giá»¯ Ä‘áº¡o chÃ­nh, Ä‘áº¡i cÃ¡t."],
["Äá»‹a Phong ThÄƒng","åœ°é¢¨å‡","ThÄƒng tiáº¿n, tá»«ng bÆ°á»›c, thuáº­n lá»£i."],
["ThiÃªn Thá»§y Tá»¥ng","å¤©æ°´è¨Ÿ","Tranh tá»¥ng, nÃªn nhÆ°á»ng, cáº©n trá»ng."],
["Phong Thá»§y HoÃ¡n","é¢¨æ°´æ¸™","Tan rÃ£, phÃ¢n tÃ¡n, rá»“i láº¡i há»£p."],
["Há»a Thá»§y Vá»‹ Táº¿","ç«æ°´æœªæ¿Ÿ","ChÆ°a hoÃ n táº¥t, cáº§n kiÃªn trÃ¬."],
["Tráº¡ch Thá»§y Khá»‘n","æ¾¤æ°´å›°","KhÃ³ khÄƒn, giá»¯ chÃ­nh thÃ¬ vÆ°á»£t qua."],
["SÆ¡n Thá»§y MÃ´ng","å±±æ°´è’™","MÃ´ng muá»™i, há»c Ä‘áº¡o, khai má»Ÿ."],
["Kháº£m Vi Thá»§y","åç‚ºæ°´","Hiá»ƒm trá»Ÿ, kiÃªn trÃ¬ vÆ°á»£t qua."],
["LÃ´i Thá»§y Giáº£i","é›·æ°´è§£","Giáº£i trá»«, cá»©u nguy, cÃ¡t."],
["Äá»‹a Thá»§y SÆ°","åœ°æ°´å¸«","Chá»‰ huy, cÃ³ tá»• chá»©c, cÃ´ng chÃ­nh."],
["ThiÃªn SÆ¡n Äá»™n","å¤©å±±é¯","RÃºt lui, giá»¯ mÃ¬nh, thuáº­n lá»£i khi thoÃ¡i."],
["Phong SÆ¡n Tiá»‡m","é¢¨å±±æ¼¸","Tiáº¿n dáº§n, á»•n Ä‘á»‹nh, cÃ¡t."],
["Há»a SÆ¡n Lá»¯","ç«å±±æ—…","Ly hÆ°Æ¡ng, gian truÃ¢n, cÃ³ quÃ½ nhÃ¢n."],
["Tráº¡ch SÆ¡n HÃ m","æ¾¤å±±å’¸","Cáº£m á»©ng, tÃ¬nh cáº£m, hÃ²a há»£p."],
["Cáº¥n Vi SÆ¡n","è‰®ç‚ºå±±","Dá»«ng láº¡i, biáº¿t Ä‘á»§, an á»•n."],
["Thá»§y SÆ¡n Kiá»ƒn","æ°´å±±è¹‡","Tráº¯c trá»Ÿ, vÆ°á»£t khÃ³, trung cÃ¡t."],
["LÃ´i SÆ¡n Tiá»ƒu QuÃ¡","é›·å±±å°é","Nhá» quÃ¡, chá»› máº¡o hiá»ƒm, giá»¯ an."],
["Äá»‹a SÆ¡n KhiÃªm","åœ°å±±è¬™","KhiÃªm tá»‘n, nhu thuáº­n, Ä‘áº¡i cÃ¡t."],
["ThiÃªn Äá»‹a BÄ©","å¤©åœ°å¦","Báº¿ táº¯c, Ã¢m thá»‹nh, giá»¯ Ä‘áº¡o chá» thá»i."],
["Phong Äá»‹a Quan","é¢¨åœ°è§€","Quan sÃ¡t, tÄ©nh láº·ng, há»c hiá»ƒu Ä‘áº¡o."],
["Há»a Äá»‹a Táº¥n","ç«åœ°æ™‰","Tiáº¿n lÃªn, thÄƒng chá»©c, Ä‘áº¡i cÃ¡t."],
["Tráº¡ch Äá»‹a Tá»¥y","æ¾¤åœ°èƒ","Tá»¥ há»p, Ä‘á»“ng lÃ²ng, Ä‘áº¡i lá»£i."],
["SÆ¡n Äá»‹a BÃ¡c","å±±åœ°å‰","Tá»•n hao, tan rÃ£, chá»› hÃ nh Ä‘á»™ng."],
["Thá»§y Äá»‹a Tá»·","æ°´åœ°æ¯”","ThÃ¢n cáº­n, há»£p tÃ¡c, cÃ¡t."],
["LÃ´i Äá»‹a Dá»±","é›·åœ°è±«","Vui váº», chuáº©n bá»‹, Ä‘á»«ng quÃ¡ Ä‘Ã ."],
["KhÃ´n Vi Äá»‹a","å¤ç‚ºåœ°","Thuáº§n Ã¢m, thuáº­n theo, nhu mÃ  tháº¯ng."]
];

function getHexIndices(dayAm,monthAm,hourChi,variant){
  const moving=((monthAm+dayAm+hourChi-1)%6)+1;
  let upperN,lowerN,up,lo;
  if(variant==="B"){upperN=((monthAm+hourChi-1)%8)+1;lowerN=((dayAm+monthAm-1)%8)+1;up=MAP_B_UPPER[upperN];lo=MAP_B_LOWER[lowerN];}
  else{upperN=((monthAm+dayAm-1)%8)+1;lowerN=((dayAm+hourChi-1)%8)+1;up=MAP_A_UPPER[upperN];lo=MAP_A_LOWER[lowerN];}
  return {upper:up,lower:lo,moving};
}

function calc(){
  const solar=document.getElementById("solarDate").value;
  const time=document.getElementById("solarTime").value;
  if(!solar){alert("Chá»n ngÃ y!");return;}
  const [y,m,d]=solar.split("-").map(Number);
  const [hh,mm]=time.split(":").map(Number);
  const iana=document.getElementById("iana").value;
  const useVN=document.getElementById("vnStd").checked;
  const tz=useVN?7:offsetHoursAt(iana,y,m,d,hh,mm);
  const variant=document.getElementById("variant").value;

  const [dayAm,monthAm,yearAm]=AmLich.convertSolar2Lunar(d,m,y,tz);
  const chiHour=chiIndexFromHour(hh);
  console.log(`Hour: ${chiHour}`);
  const {dayCan,dayChi,dayCanIndex}=dayCanChi(d,m,y);
  const {yearCan,yearChi,yearCanIndex}=yearCanChi(yearAm);
  const {monthCan,monthChi}=monthCanChi(monthAm,yearCanIndex);
  const {hourCan,hourChi}=hourCanChi(dayCanIndex,chiHour);
  const {upper,lower,moving}=getHexIndices(dayAm,monthAm,chiHour,variant);

  const lines=build(lower,upper);
  const changed=mutate(lines,moving);

  // SUY RA THÆ¯á»¢NG/Háº  Tá»ª HÃŒNH HÃ€O (Ä‘áº£m báº£o tÃªn khá»›p hÃ¬nh)
  const lowerFromLines  = trigramIndex(lines.slice(0,3));
  const upperFromLines  = trigramIndex(lines.slice(3,6));
  const lower2FromLines = trigramIndex(changed.slice(0,3));
  const upper2FromLines = trigramIndex(changed.slice(3,6));

  // Tra tÃªn quáº» tá»« báº£ng 64 quáº» theo THá»¨ Tá»° KINH ÄIá»‚N
  const idx1 = (upperFromLines - 1) * 8 + lowerFromLines;
  const idx2 = (upper2FromLines - 1) * 8 + lower2FromLines;
  const main = HEX_NAMES[idx1];
  const changedHex = HEX_NAMES[idx2];

  if (upperFromLines !== upper || lowerFromLines !== lower) {
    console.warn("âš ï¸ Mismatch mapping:",
      {calcUpper: upper, calcLower: lower, fromLinesUpper: upperFromLines, fromLinesLower: lowerFromLines}
    );
  }

  let out=`NgÃ y dÆ°Æ¡ng: ${d}/${m}/${y} ${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}\nÃ‚m lá»‹ch: ${dayAm}/${monthAm}/${yearAm}\nMÃºi giá»: ${useVN?"VN (UTC+7)":iana}\n\n`;
  out+=`ğŸ•“ Can Chi:\n  Giá»: ${hourCan} ${hourChi}\n  NgÃ y: ${dayCan} ${dayChi}\n  ThÃ¡ng: ${monthCan} ${monthChi}\n  NÄƒm: ${yearCan} ${yearChi}\n\n`;
  out+=`ğŸ”¹ Quáº» chá»§: ${main[0]} (${main[1]})\n${render(lines,moving)}âœ¨ ${main[2]}\n\n`;
  out+=`ğŸ”¸ Quáº» biáº¿n: ${changedHex[0]} (${changedHex[1]})\n${render(changed,0)}âœ¨ ${changedHex[2]}`;
  document.getElementById("out").textContent=out;
}
</script>
</body>
</html>
